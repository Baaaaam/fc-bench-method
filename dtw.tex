\clearpage
\section{Dynamic Time Warping}
\label{dtw}

Now that there are representative models of all features, the issue revolves 
around how to compare these time series models. Dynamic time warping \cite{muller}
is a method for computing the distance between any two time series. The time 
series need not be of the same length.  Furthermore, the time series may be 
decomposed into a set of representative spectra and the DTW may still be applied.
The distance computed by DTW is a measure of the changes that would need to be 
made to one time series to turn it into (warp) the other time series. Thus, 
the DTW distance is a measure over the whole time series, and not just a 
single characteristic point.

With respect to nuclear feul cycle benchmarks, there are two main DTW applictions.
The first is to compute the distance between a Gaussian process model and each of 
the simulators that made up the training set.  This gives a quantitative measure 
of how far each simulator is from the model and can help determine which 
simultors are outliers. To maintain a non-judgemental benchmark, though, it is 
critical to not then use this information to discard outliers.  Rather, outlier
identification should be used as part of an inter-code comparison. If one simulator
is an outlier for a given metric, the reasons for this should be investigated. 
For example, the outlier simulator may be at higher fidelity level, there may be 
a bug in the outlier, or there may be a bug in all other simulators. Identifying 
outliers for many metrics could help discover the underlying cause of any 
discrepencies.

The second application of DTWs to benchmarking is to compare the consituient 
feature models to the total model.  Thes distances computed in this way allow 
for a rank ordering of the componets.  This enables the benchmark to make claims
about which features drive the fuel cycle metric most strongly, over the whole 
simulation time for all simulators. Traditionally, the simulators have to agree
within nominal error bounds ($<5\%$) for a benchmark to make such a claim.  Here,
the simulators need not necessarily agree since the Gaussian process models are
used as representatives.  In this application, it is useful to recast the DTW 
distance as a measure of contribution.  This new FOM will be presented in 
\S\ref{contribution}.

For any two time series, dynamic time warping consists of three part:
the distance $d$, a cost matrix $C$, and a warp path $w$. The cost matix 
specifies how far a point on the first time series is from another point on the 
other time series.  The warp path is then the minimal cost curve through this 
matrix from the fist point in time to the last. The distance, therefore, is the
total cost of traversing the warp path.

The first step in DTW is to compute the cost matrix. Suppose that the first 
time series $x$ has length $A$ indexed by $a$ and the second time series $y$ has 
length $B$ indexed by $b$. It is helpful to define an $A\times B$ matrix $\Delta L$
that is the $L_1$ norm of the difference of time series $x$ and $y$:
\begin{equation}
\label{delta-l1}
\Delta L_{a,b} = \left|x_a - y_b\right|_1
\end{equation}
The cost matrix $C$ is then an $A\times B$ sized matrix that is defined by the 
following recurssion relations:
\begin{equation}
\label{cost-matrix}
\begin{split}
C_{1,1} & = \Delta L_{1,1}\\
C_{1,b+1} & = \Delta L_{1,b} + C_{1,b}\\
C_{a+1,1} & = \Delta L_{a,1} + C_{a,1}\\
C_{a+1,b+1} & = \Delta L_{a,b} + \min\left[C_{a,b}, C_{a+1,b}, C_{a,b+1}\right]
\end{split}
\end{equation}
The boundary conditions in Equation \ref{cost-matrix} are equivalent 
to applying an infinite cost to any $a$ or $b$ less than or equal to zero.
The units of the cost matrix are the same as the metric. However, the 
scale of the cost matrix is geometrically larger than the metric itself,
due to its compounding recursive definition.

Given $C$, the warp path is thus a sequnece of coordinate points that can then be 
computed by walking backwards through the matrix from $(A, B)$ to $(1, 1)$.
For a point $w_p$ in the warp path, the previous point $w_{p-1}$ is given by 
where the cost is minimized among the locations one column to the left, one row
down, and one diagonal element to left and down. Symbolically, 
\begin{equation}
\label{warp-path}
w_{p-1} = \argmin\left[C_{a-1,b-1}, C_{a-1,b}, C_{a,b-1}\right]
\end{equation}
The maximum possible length of $w$ is thus $A + B$ and the mimimum length is 
$\sqrt{A^2 + B^2}$. The warp path itself could potentially serve as a FOM.  
However, doing so would not take into account the cost along this path.

Therefore, the distance $d$ is defined as a FOM does include for the cost of the
warp.  Due to the relations used to define the cost matrix, $d$ can be stated
succinctly as:
\begin{equation}
\label{d-calc}
d = \frac{C_{A,B}}{A + B}
\end{equation}
That is, $d$ is the final value of the cost matrix divided by the maximal length 
of the warp path.

For all practical purposes in benchmarking, $A$ and $B$ can be forced to have the 
value because the Gaussian process model can be used to predict a time series 
with whatever time grid is desired.  The advantage of using a regression model 
is that it allows the analyst to force the same time grid.  The advantage of 
dynamic time warping is that ensuring the same time grid is not necessary.
Coupling Gaussian processes and DTW together is a more robust analysis tool 
than the methods individually.

\begin{figure}[htb]
\centering
\includegraphics[width=0.9\textwidth]{cost-lwr-model-to-lwr-cyclus.eps}
\caption{Heatmap of the cost matrix between the Gaussian process model 
for LWRs, $m_*^\LWR(t)$, and the Cyclus LWR time series, $m_\CYCLUS^\LWR(t)$.
The warp path is superimposed as the white curve on top of the cost matrix.}
\label{cost-lwr-model-to-lwr-cyclus}
\end{figure}

Figure \ref{cost-lwr-model-to-lwr-cyclus} displays and example cost matrix 
as a heat map for the DTW between the LWR Gaussian process model 
$m_*^\LWR(t)$ and the original Cyclus LWR time series $m_\CYCLUS^\LWR(t)$.
Additionally, the warp path between these two is shown as the white curve
on top of $C$. Note that while $w$ is monotonic along both time axes, the
path it takes minimizes the cost matrix at every step. Higher cost regions
have the effect of pushing the warp path along one axis or another. The 
distance between these two curves $d(m_*^\LWR, m_\CYCLUS^\LWR)$ is computed 
to be 1.053 GWe.

The process of dynamic time warping models to raw simulator data can be 
repeated for all combinations of simulators and features. The 
$d(m_*^i, m_s^i)$ that are computed may then directly serve as a FOM for
outlier identification. Only distances with the same feature my be compared
because they share the same model. For instance, it is valid to compare
$d(m_*^\LWR, m_\DYMOND^\LWR)$ and $d(m_*^\LWR, m_\CYCLUS^\LWR)$. However,  
it is not valid to compare $d(m_*^\LWR, m_\DYMOND^\LWR)$ and 
$d(m_*^\FR, m_\DYMOND^\FR)$.  In the situation, where the simulator data
has different time grids, the model can be evaluated with each time grid
prior to computing the coorespnding DTW distances and the comparison will
remain valid.

\begin{table}[htb]
\centering
\caption{Distances [GWe] between models and simulators for all combinations of 
simultors (DYMOND and Cyclus) and metric features (generated power for 
LWRs, FRs, and total). The simultors are presented in the rows and the
features are given as columns. Distances may only be compared along 
each column.}
\label{d-compare}
\begin{tabular}{l|c|c|c|}
                & \textbf{LWR} & \textbf{FR} & \textbf{Total} \\
\hline
\textbf{DYMOND} & 1.452        & 2.783       & 3.022          \\
\hline
\textbf{Cyclus} & 1.053        & 3.732       & 3.984          \\
\hline
\end{tabular}
\end{table}

Table \ref{d-compare} gives the distances for all simulator and feature 
combinations in the sample data. Only the differences between DYMOND and 
Cyclus for the same feature may be compared.  However, this does 
indicate that the DYMOND is closer to the model since both the FR and Total
generated power distances are closer for DYMOND than for Cyclus.  As many
simulators as desired could be added to the benchmark and distances could 
be tallied for them as well. At a sufficient number of simulators, usual 
statictics (mean, standard deviation) along each column may be computed.
Simulators whose metrics fall outside of a typical threshold of the mean
(one or two standard deviations) would then be considered outliers and 
subject to further inter-code comparison. The two simulators here are 
for deomnstation purposes and neither can be said to be an outlier in a
non-judgemental way. Recall, though, that outliers determined in this way 
may stem from the more correct simulator. The term outlier is not a 
condemnation on its own.

